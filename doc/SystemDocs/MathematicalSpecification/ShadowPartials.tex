% ShadowPartials.tex

\subsection{PercentShadow Partial Derivatives} \label{Sec:ShadowParials}

The \st{PercentShadow} parameter $p$ modifies the SRP acceleration to take into account the occultation of the Sun by another body:

\begin{align}
	\mba_s &= \left( 1 - \frac{p}{100} \right) \mba_{s, \mathrm{No Shadow}}.
\end{align}

\noindent The derivatives of $\mba_s$ with respect to an arbitrary variable $x$ are therefore

\begin{align}
	\frac{\partial \mba_s}{\partial x} &= -\frac{1}{100} \frac{\partial p}{\partial x} \mba_{s, \mathrm{No Shadow}} + \left( 1 - \frac{p}{100} \right) \frac{\partial  \mba_{s, \mathrm{No Shadow}}}{\partial x}.
\end{align}

\noindent Relevant derivatives of $\mba_{s, \mathrm{No Shadow}}$ are derived elsewhere. $p$ itself is dependent on the position of the spacecraft (an element of the spacecraft state) and on the positions of the Sun and the (potentially) occulting body of interest, which are assumed to be known as explicit functions of time. In addition to previously introduced variables, we define a vector from the spacecraft to the Sun:

\begin{align}
	\mathbf{d} &= \mbr_{\odot} - \mbr.
\end{align}

The derivation of $\partial p / \partial x$ differs depending on the shadow regime. If $D' \geq R_{\odot}' + R_B'$, then the spacecraft is not in the body's shadow, and $p$ is not changing. Therefore,

\begin{align}
	\frac{\partial p}{\partial x} &= 0.
\end{align}

\noindent Likewise, if $D' \leq R_B' - R_{\odot}'$, then the spacecraft is in full shadow, and $p$ is not changing. Therefore,

\begin{align}
\frac{\partial p}{\partial x} &= 0.
\end{align}

\noindent If neither of these two conditions are met, then the spacecraft is in partial shadow, and the derivatives of $p$ are nonzero. If $| R_{\odot}' - R_B' | < D' < R_{\odot}' + R_B'$, then

\begin{align}
	\frac{\partial p}{\partial x} &= \frac{100}{\pi} \left[ \frac{1}{R_{\odot}'^2} \frac{\partial A}{\partial x} - \frac{2 A}{R_{\odot}'^3} \frac{\partial R_{\odot}'}{\partial x} \right].
\end{align}

\noindent If the condition $| R_{\odot}' - R_B' | < D' < R_{\odot}' + R_B'$ is not met, then

\begin{align}
	\frac{\partial p}{\partial x} &= 100 \left[ \frac{2 R_B'}{R_{\odot}'^2} \frac{\partial R_B'}{\partial x} - \frac{2 R_B'^2}{R_{\odot}'^3} \frac{\partial R_{\odot}'}{\partial x} \right].
\end{align}

We now present the relationships required to completely define the derivatives of $p$ for the cases $x = \mbr$ and $x = t$.

For $\mbr_{\odot}$, we have

\begin{align}
	\frac{\partial \mbr_{\odot}}{\partial t} &= \mbv_{\odot} \\
	\frac{\partial \mbr_{\odot}}{\partial \mbr} &= \mathbf{0}_{3 \times 3},
\end{align}

\noindent where $\mbv_{\odot}$ is the time derivative of $\mbr_{\odot}$, i.e., the velocity vector of the Sun with respect to the central body.

For $\mbr_{B}$, we have

\begin{align}
\frac{\partial \mbr_{B}}{\partial t} &= \mbv_{B} \\
\frac{\partial \mbr_{B}}{\partial \mbr} &= \mathbf{0}_{3 \times 3},
\end{align}

\noindent where $\mbv_{B}$ is the time derivative of $\mbr_{B}$, i.e., the velocity vector of the occulting body with respect to the central body.

For $\mathbf{s}$, we have

\begin{align}
\frac{\partial \mathbf{s}}{\partial t} &= - \mbv_B \\
\frac{\partial \mathbf{s}}{\partial \mbr} &= \mathbf{I}_{3 \times 3}.
\end{align}

For $\mathbf{d}$, we have

\begin{align}
\frac{\partial \mathbf{d}}{\partial t} &= \mbv_{\odot} \\
\frac{\partial \mathbf{d}}{\partial \mbr} &= - \mathbf{I}_{3 \times 3}.
\end{align}

For $R_{\odot}'$, we have

\begin{align}
\frac{\partial R_{\odot}'}{\partial x} &= \frac{- R_{\odot}}{d^3 \sqrt{1 - R_{\odot}^2/d^2}} \mathbf{d}^T \frac{\partial \bm{d}}{\partial x},
\end{align}

\noindent where $d = \| \mathbf{d} \|$.

For $R_B'$, we have

\begin{align}
\frac{\partial R_B'}{\partial x} &= \frac{-R_B}{s^3 \sqrt{1 - R_B^2 / s^2}} \mathbf{s}^T \frac{\partial \mathbf{s}}{\partial x},
\end{align}

\noindent where $s = \| \mathbf{s} \|$.

For $D'$, we have

\begin{align}
\frac{\partial D'}{\partial x} &= \frac{1}{\| \mathbf{s} \times \mathbf{d} \|^2 + (-\mathbf{s}^T \mathbf{d})^2} \left[ \left( - \mathbf{s}^T \mathbf{d} \right) \frac{\partial \| \mathbf{s} \times \mathbf{d} \|}{\partial x} - \| \mathbf{s} \times \mathbf{d} \| \frac{\partial \left(-\mathbf{s}^T \mathbf{d} \right)}{\partial x} \right].
\end{align}

For $A$, we have

\begin{align}
\frac{\partial A}{\partial x} &= 2 R_{\odot}' \mathrm{acos} \left( \frac{c_1}{R_{\odot}'} \right) \frac{\partial R_{\odot}'}{\partial x} - \frac{R_{\odot}'^2}{\sqrt{1 - c_1^2 / R_{\odot}'^2}} \frac{\partial \left( c_1 / R_{\odot}' \right)}{\partial x} + 2 R_B' \mathrm{atan2} \left[ c_2, D' - c_1 \right] \frac{\partial R_B'}{\partial x} \\
&+ R_B'^2 \frac{\partial \left( \mathrm{atan2} \left[ c_2, D' - c_1 \right] \right)}{\partial x} - D' \frac{\partial c_2}{\partial x} - c_2 \frac{\partial D'}{\partial x}. \nonumber
\end{align}

For $c_1$, we have

\begin{align}
\frac{\partial c_1}{\partial x} &= \frac{1}{2} \left[ \frac{-1}{D'^2} \left( D'^2 + R_{\odot}'^2 - R_B'^2 \right) \frac{\partial D'}{\partial x} + \frac{2}{D'} \left( D' \frac{\partial D'}{\partial x} + R_{\odot}' \frac{\partial R_{\odot}'}{\partial x} - R_B' \frac{\partial R_B'}{\partial x} \right) \right].
\end{align}

For $c_2$, we have

\begin{align}
\frac{\partial c_2}{\partial x} &= \frac{1}{c_2} \left( R_{\odot}' \frac{\partial R_{\odot}'}{\partial x} - c_1 \frac{\partial c_1}{\partial x} \right).
\end{align}

The intermediate expressions used in the preceding equations are now given.

For $c_1 / R_{\odot}'$, we have

\begin{align}
\frac{\partial \left( c_1 / R_{\odot}' \right)}{\partial x} &= \frac{1}{R_{\odot}'} \frac{\partial c_1}{\partial x} - \frac{c_1}{R_{\odot}'^2} \frac{\partial R_{\odot}'}{\partial x}.
\end{align}

For $\mathrm{atan2} \left[ c_2, D' - c_1 \right]$, we have

\begin{align}
	\frac{\partial \left( \mathrm{atan2} \left[ c_2, D' - c_1 \right] \right)}{\partial x} &= \frac{1}{c_2^2 + \left( D' - c_1 \right)^2} \left[ \left( D' - c_1 \right) \frac{\partial c_2}{\partial x} - c_2 \left( \frac{\partial D'}{\partial x} - \frac{\partial c_1}{\partial x} \right) \right]
\end{align}

For $\mathbf{s}^T \mathbf{d}$, we have

\begin{align}
	\frac{\partial \left( - \mathbf{s}^T \mathbf{d} \right)}{\partial x} &= - \left( \mathbf{s}^T  \frac{\partial \mathbf{d}}{\partial x} + \mathbf{d}^T \frac{\partial \mathbf{s}}{\partial x} \right).
\end{align}

For $\| \mathbf{s} \times \mathbf{d} \|$, we have

\begin{align}
	\frac{\| \mathbf{s} \times \mathbf{d} \|}{\partial x} &= \frac{\left( \mathbf{s} \times \mathbf{d} \right)^T}{\| \mathbf{s} \times \mathbf{d} \|} \frac{\partial \left( \mathbf{s} \times \mathbf{d} \right)}{\partial x} \\
	\frac{\partial \left( \mathbf{s} \times \mathbf{d} \right)}{\partial t} &= \left[ \begin{array}{c}
	-v_{B,y} d_z + s_y v_{\odot, z} + v_{B, z} d_y - s_z v_{\odot, y} \\
	-v_{B,z} d_x + s_z v_{\odot, x} + v_{B, x} d_z - s_x v_{\odot, z} \\
	-v_{B,x} d_y + s_x v_{\odot, y} + v_{B, y} d_x - s_y v_{\odot, x}
	\end{array} \right] \\
	\frac{\partial \left( \mathbf{s} \times \mathbf{d} \right)}{\partial \mbr} &= \left[ \begin{array}{ccc}
	0 & d_z + s_z & -d_y - s_y \\
	-d_z - s_z & 0 & d_x + s_x \\
	d_y + s_y & -d_x - s_x & 0
	\end{array} \right].
\end{align}




