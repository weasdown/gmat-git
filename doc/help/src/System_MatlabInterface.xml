<?xml version="1.0" encoding="UTF-8"?>
<refentry version="5.0" xml:id="MatlabInterface"
          xmlns="http://docbook.org/ns/docbook"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          xmlns:xi="http://www.w3.org/2001/XInclude"
          xmlns:svg="http://www.w3.org/2000/svg"
          xmlns:m="http://www.w3.org/1998/Math/MathML"
          xmlns:html="http://www.w3.org/1999/xhtml"
          xmlns:db="http://docbook.org/ns/docbook">
  <indexterm>
    <primary>MATLAB Interface</primary>
  </indexterm>

  <refmeta>
    <refentrytitle>MATLAB Interface</refentrytitle>

    <refmiscinfo class="source">GMAT</refmiscinfo>

    <refmiscinfo class="manual">Resources</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>MATLAB Interface</refname>

    <refpurpose>Interface to MATLAB system</refpurpose>
  </refnamediv>

  <refsection>
    <title>Description</title>

    <para>The MATLAB interface provides a link to the Mathworks MATLAB
    environment, allowing GMAT to run MATLAB functions as if they were native
    functions in the GMAT script language.</para>

    <para>The interface cannot be controlled directly through the script
    language, though it can be in the GMAT GUI. Instead, GMAT starts the
    interface automatically when it calls a MATLAB function.</para>

    <para>There are two GMAT components that provide user access to the
    interface. For details on declaring a MATLAB function, see the
    <guilabel><xref linkend="MatlabFunction"/></guilabel> reference. For
    details on calling a function and passing data, see the <guilabel><xref
    linkend="CallMatlabFunction"/></guilabel> reference.</para>

    <para><phrase role="ref_seealso">See Also</phrase>: <xref
    linkend="CallMatlabFunction"/>, <xref linkend="MatlabFunction"/></para>
  </refsection>

  <refsection>
    <title>GUI</title>

    <screenshot>
      <mediaobject>
        <imageobject>
          <imagedata align="center" contentdepth="100%"
                     fileref="files/images/System_MatlabInterface_ResourcesTree.png"
                     scalefit="1" width="100%"/>
        </imageobject>
      </mediaobject>
    </screenshot>

    <para>The MATLAB interface provides an icon in the
    <guilabel>Interfaces</guilabel> folder in the Resources tree that can be
    used to control the interface. Right-clicking the icon shows two options:
    <guilabel>Open</guilabel> and <guilabel>Close</guilabel>.</para>

    <para>The <guilabel>Open</guilabel> menu item causes GMAT to open a
    connection to the MATLAB Engine, which in turns displays a MATLAB command
    window in the background. This connection is then used for all
    communication between GMAT and MATLAB until the connection is closed. Only
    one connection can be open at a time.</para>

    <para>The <guilabel>Close</guilabel> menu item causes GMAT to close any
    open connection to the MATLAB Engine. If no connection is open, it has no
    effect.</para>
  </refsection>

  <refsection>
    <title>Remarks</title>

    <refsection>
      <title xml:id="System_MatlabInterface_InterfaceSetup">Interface
      Setup</title>

      <para>The following conditions must be true for GMAT to successfully
      initiate communication with MATLAB. All conditions must be true for the
      same instance of MATLAB.</para>

      <itemizedlist spacing="normal">
        <listitem>
          <para>Install a compatible, licensed version of MATLAB on the same
          machine on which GMAT is running. GMAT is tested with the latest
          version of MATLAB at the time of release, though versions R2006b and
          newer have been known to work.</para>
        </listitem>

        <listitem>
          <para>The architecture (32-bit or 64-bit) of GMAT and the installed
          version of MATLAB must match. For example, the 32-bit version of
          GMAT is compatible only with the 32-bit version of MATLAB.</para>
        </listitem>

        <listitem>
          <para>On Windows:<orderedlist>
              <listitem>
                <para>Add the following path (where
                <filename><replaceable>MATLAB</replaceable></filename> is the
                path to the installed version of MATLAB) to your
                <envar>Path</envar> environment variable (either your user
                variable, or the system variable). If you continue to have
                trouble, try putting this path at the very beginning of your
                system path.</para>

                <para><filename><replaceable>MATLAB</replaceable>\bin\win32</filename>
                (or <filename>win64</filename> for use with 64-bit versions of
                GMAT)</para>
              </listitem>

              <listitem>
                <para>Register MATLAB for use as a COM server by
                running:</para>

                <para><userinput>matlab -regserver</userinput></para>

                <para>This is done automatically by the MATLAB installer. To
                do it manually, open an elevated command window and run the
                command above. Make sure to run the command in the folder
                containing the executable you wish to use (i.e.
                <replaceable>MATLAB</replaceable>\bin\win32 or
                <replaceable>MATLAB</replaceable>\bin\win64.)</para>
              </listitem>
            </orderedlist></para>
        </listitem>

        <listitem>
          <para>On macOS:<orderedlist>
              <listitem>
                <para>Open the MacConfigure.txt in the bin directory and edit
                the MATLAB_APP_PATH field to point to the location of your
                MATLAB application bundle.</para>
              </listitem>

              <listitem>
                <para>If the Matlab interface does not work with the
                GmatConsole command line application, you may need to set up
                your Terminal so that the system can load the Matlab libraries
                and start up MATLAB. For example, if you are using a .bashrc,
                you may need to add something like this:</para>

                <para><userinput>export MATLAB =
                &lt;path/to/MATLAB/app/location/&gt;</userinput></para>

                <para><userinput>export
                DYLD_LIBRARY_PATH=$MATLAB/bin/maci64:$DYLD_LIBRARY_PATH</userinput></para>

                <para><userinput>export
                PATH=$PATH:$MATLAB/bin</userinput></para>
              </listitem>
            </orderedlist><note>
              <para>64-bit GMAT must be used to interface with MATLAB after
              version R2010a.</para>
            </note></para>
        </listitem>

        <listitem>
          <para>On Linux: <itemizedlist>
              <listitem>
                <para>The MATLAB interface on Linux requires that the C shell,
                csh, be installed. This is a requirement from the MathWorks
                for startup of the MATLAB engine, used for the interface. If
                your system does not have csh installed, the package manager
                for your Linux installation should include csh as an
                installation option.</para>

                <para>The MATLAB interface needs to be able to locate the
                MATLAB shared libraries libeng.so (and related libraries) and
                libMatlabEngine.so. For MATLAB R2019a, the former is in the
                MATLAB bin/glnxa64 folder and the latter in MATLAB's
                extern/bin/glnxa64 folder. One way to start GMAT and apply the
                library path settings is to launch the application with a
                library path. From the Linux terminal, the command (for MATLAB
                installed in the default /usr/local/MATLAB/R2019a
                folder)</para>

                <para><userinput>LD_LIBRARY_PATH=/usr/local/MATLAB/R2019a/extern/bin/glnxa64:/usr/local/MATLAB/R2019a/bin/glnxa64
                ./GMAT</userinput></para>

                <para>accomplishes this task, starting the GMAT GUI with the
                settings needed to run the MATLAB interface.</para>
              </listitem>
            </itemizedlist></para>
        </listitem>
      </itemizedlist>

      <note>
        <para>Common troubleshooting tips on Windows:</para>

        <itemizedlist>
          <listitem>
            <para>If you are using the officially-released 32-bit version of
            GMAT, make sure you have the 32-bit version of MATLAB
            installed.</para>
          </listitem>

          <listitem>
            <para>If the path above exists in your system <envar>Path</envar>
            variable, try place it at the front.</para>
          </listitem>

          <listitem>
            <para>Make sure the same instance of MATLAB is referenced both in
            the <envar>Path</envar> variable and when running
            <userinput>matlab -regserver</userinput>.</para>
          </listitem>
        </itemizedlist>
      </note>
    </refsection>

    <refsection>
      <title>MATLAB Engine Connection</title>

      <warning>
        <para>Caution: GMAT does not close the MATLAB Command Window it
        creates after a run has completed. This allows manual inspection of
        the MATLAB workspace, but it can lead to confusing behavior if MATLAB
        functions or paths are changed and rerun in the same window.</para>

        <para>We recommend closing the MATLAB Command Window by right-clicking
        Matlab in the Resources tree and clicking Close between each run if
        you are actively editing the script.</para>
      </warning>

      <para>When GMAT runs a mission that contains a MATLAB function call, it
      opens a connection to the MATLAB engine before it makes the function
      call. It then reuses this connection for the rest of the GMAT
      session.</para>

      <para>The MATLAB Engine can be controlled manually through the
      <guilabel>Open</guilabel> and <guilabel>Close</guilabel> options
      available by right-clicking the <guilabel>Matlab</guilabel> item in the
      Resources tree.</para>
    </refsection>
  </refsection>

  <refsection>
    <title>Examples</title>

    <para>See the <xref linkend="MatlabFunction"/> reference for common
    examples.</para>
  </refsection>
</refentry>
